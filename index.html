<html lang="en-US" style="height: 100%;">
<head>
	<!--
		Code developed by Steffen Sanwald.
		Based on https://github.com/openpgpjs/openpgpjs and https://www.stoerkind.de/SicheresMailformular
	-->
	<meta charset="utf-8">
<script src="openpgpjs/dist/openpgp.js"></script>
<script src='https://www.hCaptcha.com/1/api.js' async defer></script>
</head>
<body>

	<form action="contact.php" method="post" role="form" id="myForm">	
		<label for="contactname">Name:</label><br>
		<input type="text" id="contactname" value="Max Mustermann"><br>
	  
		<label for="email">Email:</label><br>
		<input type="text" id="email" value="max@mustermann.de"><br>
	  
		<label for="subject">Subject:</label><br>
		<input type="text" id="subject" value="Your offer from last sunday"><br>
	  
		<label for="content">Content:</label><br>
		<input type="text" id="content" value="Hey Max">
		<!-- official dummy value for data-sitekey taken from https://docs.hcaptcha.com.
			Can be used for debugging.
			Replace value with the one from your hcaptcha instance -->
		<div class="h-captcha" data-sitekey="10000000-ffff-ffff-ffff-000000000001"></div>
		
		
		<input id="encryptedmessage" name="encryptedmessage" type="hidden" placeholder="">
		<input name="submit-msg" ID="submit-msg" type="Button" value="Text mit OpenPGP verschlÃ¼sseln!" onclick="on_button_click(this);" class="warning button"/>  
		
		<input id="pubkey" type="hidden" value=
"-----BEGIN PGP PUBLIC KEY BLOCK-----
Comment: Alice's OpenPGP certificate
Comment: https://www.ietf.org/id/draft-bre-openpgp-samples-01.html

mDMEXEcE6RYJKwYBBAHaRw8BAQdArjWwk3FAqyiFbFBKT4TzXcVBqPTB3gmzlC/U
b7O1u120JkFsaWNlIExvdmVsYWNlIDxhbGljZUBvcGVucGdwLmV4YW1wbGU+iJAE
ExYIADgCGwMFCwkIBwIGFQoJCAsCBBYCAwECHgECF4AWIQTrhbtfozp14V6UTmPy
MVUMT0fjjgUCXaWfOgAKCRDyMVUMT0fjjukrAPoDnHBSogOmsHOsd9qGsiZpgRnO
dypvbm+QtXZqth9rvwD9HcDC0tC+PHAsO7OTh1S1TC9RiJsvawAfCPaQZoed8gK4
OARcRwTpEgorBgEEAZdVAQUBAQdAQv8GIa2rSTzgqbXCpDDYMiKRVitCsy203x3s
E9+eviIDAQgHiHgEGBYIACAWIQTrhbtfozp14V6UTmPyMVUMT0fjjgUCXEcE6QIb
DAAKCRDyMVUMT0fjjlnQAQDFHUs6TIcxrNTtEZFjUFm1M0PJ1Dng/cDW4xN80fsn
0QEA22Kr7VkCjeAEC08VSTeV+QFsmz55/lntWkwYWhmvOgE=
=iIGO
-----END PGP PUBLIC KEY BLOCK-----"/> 
<!-- must have no space to the left-->
</form>  


<script>
function on_button_click(evt){
	/*	
	Evaluates password strength as meta information and attaches it to hidden pw meta form input.
	Decrypt it for testing via: gpg --output test.msg --decrypt test.msg.pgp
	But first check captcha client-sided
	*/
	var hcaptchaVal = document.getElementsByName("h-captcha-response")[0].value; 
   if (hcaptchaVal === "") {
      event.preventDefault();
      alert("Please complete the hCaptcha");
   }
  (async () => {
	  
	var form = document.getElementById("myForm");
	if (form==null || form.elements["pubkey"]==null || form.elements["contactname"]==null || form.elements["email"]==null || form.elements["subject"] == null || 
		form.elements["content"] == null || form.elements["encryptedmessage"] == null){
		return false;
	}
	
	var plaintext="Name:" + form.elements["contactname"].value + " Email:"+form.elements["email"].value + 
			" Subject:"+form.elements["subject"].value+ " Content:"+form.elements["content"].value;
	var publicKeyArmored = ""+form.elements["pubkey"].value;
    await openpgp.initWorker({ path: 'openpgpjs/dist/openpgp.worker.js' }); // set the relative web worker path

    const { data: encrypted } = await openpgp.encrypt({
        message: openpgp.message.fromText(plaintext),                 
        publicKeys: (await openpgp.key.readArmored(publicKeyArmored)).keys,
    });
    console.log(encrypted); 
	form.elements["encryptedmessage"].value=encrypted;
	form.submit();
})();

}
</script>
</body>
</html>
