<html lang="en-US" style="height: 100%;">
<head>
	<!--
		Code developed by Steffen Sanwald.
		Based on https://github.com/openpgpjs/openpgpjs and https://www.stoerkind.de/SicheresMailformular
	-->
	<meta charset="utf-8">
	<meta name="pgp-pubkey" id="pgp-pubkey" content=
"-----BEGIN PGP PUBLIC KEY BLOCK-----
Comment: Alice's OpenPGP certificate
Comment: https://www.ietf.org/id/draft-bre-openpgp-samples-01.html

mDMEXEcE6RYJKwYBBAHaRw8BAQdArjWwk3FAqyiFbFBKT4TzXcVBqPTB3gmzlC/U
b7O1u120JkFsaWNlIExvdmVsYWNlIDxhbGljZUBvcGVucGdwLmV4YW1wbGU+iJAE
ExYIADgCGwMFCwkIBwIGFQoJCAsCBBYCAwECHgECF4AWIQTrhbtfozp14V6UTmPy
MVUMT0fjjgUCXaWfOgAKCRDyMVUMT0fjjukrAPoDnHBSogOmsHOsd9qGsiZpgRnO
dypvbm+QtXZqth9rvwD9HcDC0tC+PHAsO7OTh1S1TC9RiJsvawAfCPaQZoed8gK4
OARcRwTpEgorBgEEAZdVAQUBAQdAQv8GIa2rSTzgqbXCpDDYMiKRVitCsy203x3s
E9+eviIDAQgHiHgEGBYIACAWIQTrhbtfozp14V6UTmPyMVUMT0fjjgUCXEcE6QIb
DAAKCRDyMVUMT0fjjlnQAQDFHUs6TIcxrNTtEZFjUFm1M0PJ1Dng/cDW4xN80fsn
0QEA22Kr7VkCjeAEC08VSTeV+QFsmz55/lntWkwYWhmvOgE=
=iIGO
-----END PGP PUBLIC KEY BLOCK-----"> 
<script src="openpgpjs/dist/openpgp.js"></script>
<!--<script src='https://www.hCaptcha.com/1/api.js' async defer></script>-->
</head>
<body>

	<form action="contact.php" method="post" role="form" id="myForm">	
		<label for="contactname">Name:</label><br>
		<input type="text" id="contactname" placeholder="Max Mustermann"><br>
	  
		<label for="email">Email:</label><br>
		<input type="text" id="email" placeholder="max@mustermann.de" required pattern="[Bb]anana|[Cc]herry"><br>
	  
		<label for="subject">Subject:</label><br>
		<input type="text" id="subject" placeholder="Your offer from last sunday"><br>
	  
		<label for="content">Content:</label><br>
		<input type="text" id="content" placeholder="Hey Max" required>
		<!-- official dummy value for data-sitekey taken from https://docs.hcaptcha.com.
			Can be used for debugging.
			Replace value with the one from your hcaptcha instance -->

		<input id="encryptedmessage" name="encryptedmessage" type="hidden" placeholder="">		  
		<button id="submit-msg" name="submit-msg" class="h-captcha" data-sitekey="10000000-ffff-ffff-ffff-000000000001" data-callback="after_capture_success" value="Submit encrypted"></button>
		
		<p id="result">Not yet</p>
<!-- must have no space to the left-->
</form>  


<script>

function after_capture_success(evt){
	/*	
	Evaluates password strength as meta information and attaches it to hidden pw meta form input.
	Decrypt it for testing via: gpg --output test.msg --decrypt test.msg.pgp
	But first check captcha client-sided
	*/

  (async () => {
	var hcaptchaVal = document.getElementsByName("h-captcha-response")[0].value; 
   if (hcaptchaVal === "") {
      event.preventDefault();
      alert("Please complete the hCaptcha");
   }
	  
	var form = document.getElementById("myForm");
	var result = is_form_input_valid(form);
	if(!result[0]){
		console.log("Form input failed:"+result[1]);
		return false;
	}
    var form_jq=$(form);    
    var action = form_jq.attr('action');
    var publicKeyArmored = document.getElementById("pgp-pubkey").content;
    if ( publicKeyArmored == null){
		console.log("public key not specified");
		return false;
	  }
	
	var plaintext="Name:" + form.elements["contactname"].value + " Email:"+form.elements["email"].value + 
			" Subject:"+form.elements["subject"].value+ " Content:"+form.elements["content"].value;
	
    await openpgp.initWorker({ path: 'openpgpjs/dist/openpgp.worker.js' }); // set the relative web worker path

    const { data: encrypted } = await openpgp.encrypt({
        message: openpgp.message.fromText(plaintext),                 
        publicKeys: (await openpgp.key.readArmored(publicKeyArmored)).keys,
    });
	console.log("Raw msg:"+encrypted); 

	var trimmed=trim_pgp_message(encrypted);
	  console.log("Send msg:"+trimmed); 
	  //check whether trimming somehow destroyed the content
      if(encrypted.indexOf(trimmed)<0 || /^([A-Za-z0-9+/=\r\n]+)$/.test(trimmed)==false){
		console.log("Trimming deleted pgp message content or contains not base64 characters"); 
		return false;
	  }
	  var transmitted_val="encryptedmessage="+trimmed+"&h-captcha-response="+hcaptchaVal;
	  // transfer data via AJAX POST request	  
	  $.ajax({
      type: "POST",
      url: action,
	  data: transmitted_val,
	  encode:false,
	  process:false,
      success: function(msg) {		
		  document.getElementById("result").innerText=msg;//for easy debugging on Smartphone
		  
		  if (msg == 'Valid' || msg=="Invalid") {  //if only one of these words is returned, debug is off.
			if (msg == 'Valid') {
			console.log("Submitted encrypted data successfully");
			} else {
			console.log("Submitted encrypted data failed");
			}
		}
		else{//debug messages are enabled. JSON object returned
			response=JSON.parse(msg);			
			if (response["result"] == 'Valid') {
			console.log("Submitted encrypted data successfully (DEBUG ON)") 
			} else {

				msg=escapeHtml(response["msg"]);
				result=escapeHtml(response["result"]);
				info=escapeHtml(response["info"]);
			console.log("Submitted encrypted data failed (DEBUG ON)");
			console.log(result);
			console.log(info);
			console.log(msg);
			if(response["log"]!=null){
				response["log"].forEach(function (item,index){
				console.log("Log"+index+":"+escapeHtml(item));
			})
			}
			
			}
		}
      }
    });
})();
}

	
	
	  

</script>

<script src="js/jquery.min.js"></script>
<script src="js/check_input.js">
	add_lazyload_handlers();
</script>
</body>
</html>
